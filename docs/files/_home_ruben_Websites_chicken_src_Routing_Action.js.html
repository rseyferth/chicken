<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>/home/ruben/Websites/chicken/src/Routing/Action.js</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title=""></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/Api.Api.html">Api.Api</a></li>
            
                <li><a href="../classes/Api.ApiCall.html">Api.ApiCall</a></li>
            
                <li><a href="../classes/Api.JsonApi.html">Api.JsonApi</a></li>
            
                <li><a href="../classes/Api.JsonApiCall.html">Api.JsonApiCall</a></li>
            
                <li><a href="../classes/Application.html">Application</a></li>
            
                <li><a href="../classes/Auth.Auth.html">Auth.Auth</a></li>
            
                <li><a href="../classes/Auth.JWTAuth.html">Auth.JWTAuth</a></li>
            
                <li><a href="../classes/Core.ComputedProperty.html">Core.ComputedProperty</a></li>
            
                <li><a href="../classes/Core.Obj.html">Core.Obj</a></li>
            
                <li><a href="../classes/Core.Observable.html">Core.Observable</a></li>
            
                <li><a href="../classes/Core.ObservableArray.html">Core.ObservableArray</a></li>
            
                <li><a href="../classes/Core.SettingsObject.html">Core.SettingsObject</a></li>
            
                <li><a href="../classes/Data.Model.html">Data.Model</a></li>
            
                <li><a href="../classes/Dom.ActionBinding.html">Dom.ActionBinding</a></li>
            
                <li><a href="../classes/Dom.Binding.html">Dom.Binding</a></li>
            
                <li><a href="../classes/Dom.Component.html">Dom.Component</a></li>
            
                <li><a href="../classes/Dom.Element.html">Dom.Element</a></li>
            
                <li><a href="../classes/Dom.Helpers.html">Dom.Helpers</a></li>
            
                <li><a href="../classes/Dom.Renderer.html">Dom.Renderer</a></li>
            
                <li><a href="../classes/Dom.View.html">Dom.View</a></li>
            
                <li><a href="../classes/Dom.ViewContainer.html">Dom.ViewContainer</a></li>
            
                <li><a href="../classes/Helpers.Utils.html">Helpers.Utils</a></li>
            
                <li><a href="../classes/Routing.Action.html">Routing.Action</a></li>
            
                <li><a href="../classes/Routing.Controller.html">Routing.Controller</a></li>
            
                <li><a href="../classes/Routing.Request.html">Routing.Request</a></li>
            
                <li><a href="../classes/Routing.Route.html">Routing.Route</a></li>
            
                <li><a href="../classes/Routing.RouteMatch.html">Routing.RouteMatch</a></li>
            
                <li><a href="../classes/Routing.Router.html">Routing.Router</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/Api.html">Api</a></li>
            
                <li><a href="../modules/Auth.html">Auth</a></li>
            
                <li><a href="../modules/AuthError.html">AuthError</a></li>
            
                <li><a href="../modules/Core.html">Core</a></li>
            
                <li><a href="../modules/Data.html">Data</a></li>
            
                <li><a href="../modules/Dom.html">Dom</a></li>
            
                <li><a href="../modules/Helpers.html">Helpers</a></li>
            
                <li><a href="../modules/Localization.html">Localization</a></li>
            
                <li><a href="../modules/Routing.html">Routing</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: /home/ruben/Websites/chicken/src/Routing/Action.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
import XRegExp from &#x27;xregexp&#x27;;

import App from &#x27;~/Helpers/App&#x27;;
import Obj from &#x27;~/Core/Obj&#x27;;
import Redirect from &#x27;~/Routing/Redirect&#x27;;
import Controller from &#x27;~/Routing/Controller&#x27;;
import View from &#x27;~/Dom/View&#x27;;
import Utils from &#x27;~/Helpers/Utils&#x27;;

/**
 * @module Routing
 */
class Action extends Obj
{

	/**
	 * @class Routing.Action
	 * @extends Core.Obj
	 */
	constructor(targetViewContainer, controllerActionOrCallback, request) {

		super();

		////////////////
		// Attributes //
		////////////////

		/**
		 * The name of the ViewContainer that this action is targeting.
		 * 
		 * @property targetViewContainer
		 * @type {string}
		 */
		this.targetViewContainer = targetViewContainer;


		/**
		 * The Request instance that was used to create this action
		 * 
		 * @property request
		 * @type {Routing.Request}
		 */
		this.request = request;


		/**
		 * The Route that defined this action
		 *
		 * @property route
		 * @type {Routing.Route}
		 */
		this.route = null;


		/**
		 * The Route that matched the Request
		 *
		 * @property matchedRoute
		 * @type {Routing.Route}
		 */
		this.matchedRoute = null;


		/**
		 * The RouteMatch that this Action is a part
		 *
		 * @property routeMatch
		 * @type {Routing.RouteMatch}
		 */
		this.routeMatch = null;


		/**
		 * The instance of the Controller that has been created by 
		 * this action.
		 * 
		 * @property controller
		 * @type {Routing.Controller}
		 */
		this.controller = null;


		/**
		 * The name of the Controller class used by this action
		 * 
		 * @property controllerClass
		 * @type {string}
		 */
		this.controllerClass = null;

		/**
		 * The name of the Controller method used by this action
		 * 
		 * @property controllerMethod
		 * @type {string}
		 */
		this.controllerMethod = null;


		/**
		 * A callback function, when the route did not configure
		 * a Controller to be used, but an inline callback instead.
		 * 
		 * @property callback
		 * @type {function}
		 */
		this.callback = false;


		/**
		 * A map of request parameters that are supplied to this action.
		 * 
		 * @property parameters
		 * @type {Map}
		 */
		this.parameters = new Map();


		/**
		 * An array of request parameters, in the order of the route&#x27;s
		 * pattern definition
		 *
		 * @property parameterArray
		 * @type {Array}
		 */
		this.parameterArray = [];


		/**
		 * An array of other Actions that this Action depends on, 
		 * meaning it will wait for them to finish, before executing.
		 *
		 * This is useful when you have a route where the second action
		 * renders into a ViewContainer that is created by the first action.
		 * Child routes will automatically wait for the parent route to finish
		 * before running it&#x27;s own actions.
		 * 
		 * @property dependsOn
		 * @type {Array}
		 */
		this.dependsOn = [];




		///////////////////////////
		// Check passed argument //
		///////////////////////////

		if (typeof controllerActionOrCallback === &#x27;string&#x27;) {

			// Parse controller name
			var match = XRegExp.exec(controllerActionOrCallback, Action.getControllerActionRegExp());
			if (!match) throw new TypeError(&#x27;Invalid action string: &#x27; + controllerActionOrCallback + &#x27;. Use controller@method format.&#x27;);
			
			// Store this
			this.controllerClass = match.class;
			this.controllerAction = match.action;



		} else if (typeof controllerActionOrCallback === &#x27;function&#x27;) {

			// Store it
			this.callback = controllerActionOrCallback;

		} else {

			throw new TypeError(&#x27;[Routing.Action] Did not understand action: &#x27; + controllerActionOrCallback);

		}

	}

	
	execute(application) {

		// Make the promise
		return this.promise(&#x27;complete&#x27;, (resolve, reject) =&gt; {

			// Get the view container
			this.viewContainer = application.getViewContainer(this.targetViewContainer);
			if (this.viewContainer === undefined) {
				reject(&#x27;There is no ViewContainer available with the name &quot;&#x27; + this.targetViewContainer + &#x27;&quot;&#x27;);
				return;
			}

			// Is there currently an action in this vc?
			if (this.viewContainer.currentAction) {

				// Was it triggered by the same route?
				if (Utils.uidFor(this.viewContainer.currentAction.route) === Utils.uidFor(this.route)) {

					// That means, we&#x27;ve just navigated within nested routes of that page, and this action can be skipped.
					resolve();
					return;

				}
				
			}


			// The VC is busy now.
			this.viewContainer.setLoading(true);

			////////////////
			// Controller //
			////////////////

			if (this.controllerClass) {

				// Make controller
				var ChickenController = Controller.registry.get(this.controllerClass);
				if (ChickenController === undefined) {
					reject(&#x27;No controller defined with name &quot;&#x27; + this.controllerClass + &#x27;&quot;&#x27;);
					return;
				}
				this.controller = new ChickenController(this);

				// Call action
				var controllerAction = this.controller[this.controllerAction];
				if (controllerAction === &#x27;undefined&#x27; || typeof controllerAction !== &#x27;function&#x27;) {
					reject(&#x27;There is no action on the &quot;&#x27; + this.controllerClass + &#x27;&quot; controller with the name &quot;&#x27; + this.controllerAction + &#x27;&quot;&#x27;);
					return;
				}

				// Make the call
				this._processResult(controllerAction.apply(this.controller, this.parameterArray), resolve, reject);

			} 

			//////////////
			// Callback //
			//////////////
			else if (this.callback) {
				
				// Do the callback
				this._processResult(this.callback.apply(this.controller, this.parameterArray), resolve, reject);

			} else {
				reject(&#x27;There is no controller or callback defined... This shouldn\&#x27;t happen.&#x27;);
				return;
			}

		}).then((/* result */) =&gt; {

		}, (/* error */) =&gt; {

			// No longer loading
			if (this.viewContainer) this.viewContainer.setLoading(false);

		});

	}

	_processResult(result, resolve, reject) {

		// A redirect?
		if (result instanceof Redirect) {

			//@TODO Cancel the running request?
			
			App().goto(result.uri);

		}

		///////////////////////////
		// Is the result a view? //
		///////////////////////////

		else if (result instanceof View) {

			// Render the view
			let view = result;
			view.render().then(() =&gt; {

				// Add it
				this.viewContainer.setAction(this);
				view.addToContainer(this.viewContainer);
				resolve();

			}, (error) =&gt; {
				reject(error);
			});

		}

		//////////////////////////////
		// Is the result a promise? //
		//////////////////////////////
		
		else if (result instanceof Promise) {

			// Wait for it to finish
			result.then((promiseResult) =&gt; {

				// Process result again!
				this._processResult(promiseResult, resolve, reject);

			}, (error) =&gt; {
				reject(error);
			});

		}

		/////////////////////////////////
		// Is it rendarable by itself? //
		/////////////////////////////////

		else {

			// A string
			if (typeof result === &#x27;string&#x27; || result instanceof DocumentFragment) {

				// Set content
				this.viewContainer.setAction(this);
				this.viewContainer.setContent(result);
				resolve();

			} else {

				// Don&#x27;t know how to render this...
				reject(&#x27;I don\&#x27;t know how to render the result for &quot;&#x27; + this.targetViewContainer + &#x27;&quot;&#x27;);
				return;

			}

		}		

	}


}


var _controllerActionRegExp;
Action.getControllerActionRegExp = () =&gt; {
	if (_controllerActionRegExp === undefined) {
		_controllerActionRegExp = XRegExp(&#x27;^(?&lt;class&gt;[A-Z][a-zA-Z0-9\-\.]+)@(?&lt;action&gt;[a-z][a-zA-Z0-9\_]+)$&#x27;);
	}
	return _controllerActionRegExp;
};


module.exports = Action;

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
